<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trendyol FiyatlandÄ±rma SimÃ¼latÃ¶rÃ¼</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#22c55e; --err:#ef4444; --border:#1f2937; }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:linear-gradient(180deg,#0b1023,#0f172a);color:#e5e7eb;margin:0;padding:24px}
    h1{font-size:26px;margin:0 0 8px}
    p.sub{color:var(--muted);margin:0 0 22px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .span-12{grid-column:span 12}
    .span-6{grid-column:span 12}
    @media(min-width:980px){.span-6{grid-column:span 6}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;border-radius:10px;padding:10px 12px;outline:none}
    input:focus{border-color:#334155}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}
    th{color:#cbd5e1;font-weight:600;background:#0b1220;position:sticky;top:0}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#1e293b;border:1px solid #334155;color:#e5e7eb;padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#243041}
    .btn-accent{background:var(--accent);border-color:#16a34a;color:#06210f;font-weight:700}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 140px}
    .kpi{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border:1px dashed #334155;border-radius:12px}
    .k-green{color:#22c55e}
    .k-red{color:#f87171}
    .small{font-size:12px}
    .note{color:#94a3b8;font-size:12px;margin-top:8px}
    .pill{background:#0b1220;border:1px solid #2a3346;border-radius:999px;padding:4px 10px;font-size:12px;color:#cbd5e1}
  </style>
</head>
<body>
  <h1>Trendyol FiyatlandÄ±rma SimÃ¼latÃ¶rÃ¼</h1>
  <p class="sub">Komisyon, kargo ve kÃ¢rÄ± tek sayfada gÃ¶rÃ¼n. <span class="pill">v1.1</span></p>

  <!-- ANA GRID: Mini KoÃ§ + Ayarlar + ÃœrÃ¼nler + Sepet -->
  <div class="grid">

    <!-- Ä°BRAHÄ°M BEY'E MÄ°NÄ° KOÃ‡ -->
    <section class="card span-12">
      <h2>Ä°brahim Bey'e Mini KoÃ§ ğŸ’›</h2>
      <ol class="small" style="line-height:1.6">
        <li><b>Ayarlar</b>â€™a komisyon %, eÅŸik (300 TL) ve desiâ€“kargo tablosunu gir.</li>
        <li><b>ÃœrÃ¼nler</b>â€™de maliyet+desi+marj yaz â†’ tekli satÄ±ÅŸ iÃ§in eÅŸik altÄ±/Ã¼stÃ¼ liste Ã¶nerini gÃ¶r.</li>
        <li><b>Sepet SimÃ¼latÃ¶rÃ¼</b> ile Ã§oklu adet/Ã¼rÃ¼n senaryosunda net kÃ¢rÄ± test et.</li>
        <li><b>AkÄ±llÄ± Fiyat Bulucu</b>â€™da rakip en dÃ¼ÅŸÃ¼k/ortalama fiyatÄ± gir â†’ â€œÃ–neriyi Hesaplaâ€. Ben sana
          kÃ¢rÄ± koruyarak rekabetÃ§i fiyatÄ± Ã§Ä±karÄ±rÄ±m. AÄŸÄ±r Ã¼rÃ¼nse eÅŸik altÄ±, hafif Ã¼rÃ¼nse eÅŸik Ã¼stÃ¼ daha mantÄ±klÄ± olabilir.</li>
      </ol>
    </section>

    <!-- AYARLAR -->
    <section class="card span-6">
      <h2>Ayarlar</h2>
      <div class="row">
        <div>
          <label>Komisyon OranÄ± (%)</label>
          <input type="number" id="commission" value="15" step="0.1" />
        </div>
        <div>
          <label>Ãœcretsiz Kargo EÅŸiÄŸi (TL)</label>
          <input type="number" id="freeThreshold" value="300" />
        </div>
        <div>
          <label>Kargo Bedelleri KDV Dahil mi?</label>
          <select id="shipVat"><option value="evet" selected>Evet</option><option value="hayir">HayÄ±r</option></select>
        </div>
      </div>
      <div style="height:10px"></div>
      <label>Kargo Desi Tablosu (altâ€“Ã¼stâ€“fiyat)</label>
      <table id="desiTable">
        <thead><tr><th>Desi Alt</th><th>Desi Ãœst</th><th>Kargo (TL)</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px"><button class="btn" id="addDesi">+ SatÄ±r Ekle</button> <button class="btn" id="resetDesi">SÄ±fÄ±rla</button></div>
      <p class="note">Toplam desi hangi aralÄ±ÄŸa dÃ¼ÅŸerse o satÄ±rÄ±n kargo bedeli uygulanÄ±r. Ã–rn: 0â€“1 desi = 78 TL.</p>
    </section>

    <!-- ÃœRÃœNLER LÄ°STESÄ° -->
    <section class="card span-6">
      <h2>ÃœrÃ¼nler</h2>
      <table id="productTable">
        <thead>
          <tr>
            <th>ÃœrÃ¼n</th>
            <th>Maliyet (TL)</th>
            <th>Desi</th>
            <th>Hedef KÃ¢r MarjÄ± (%)</th>
            <th>Ã–neri (EÅŸik AltÄ±)</th>
            <th>Ã–neri (EÅŸik ÃœstÃ¼)</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px"><button class="btn" id="addProduct">+ ÃœrÃ¼n SatÄ±rÄ±</button></div>
      <p class="note">Ã–neriler tek Ã¼rÃ¼n iÃ§indir. EÅŸik altÄ±: kargoyu mÃ¼ÅŸteri Ã¶der. EÅŸik Ã¼stÃ¼: kargoyu satÄ±cÄ± Ã¶der (tekli sipariÅŸ varsayÄ±mÄ±yla).</p>
    </section>

    <!-- SEPET SÄ°MÃœLATÃ–RÃœ -->
    <section class="card span-12">
      <h2>Sepet SimÃ¼latÃ¶rÃ¼</h2>
      <table id="basketTable">
        <thead>
          <tr>
            <th>ÃœrÃ¼n</th>
            <th>Birim Fiyat</th>
            <th>Birim Maliyet</th>
            <th>Desi</th>
            <th>Adet</th>
            <th>SatÄ±r TutarÄ±</th>
            <th>Maliyet ToplamÄ±</th>
            <th>Desi ToplamÄ±</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px"><button class="btn" id="addBasket">+ SatÄ±r Ekle</button></div>

      <div class="grid" style="margin-top:16px">
        <div class="span-6">
          <div class="kpi"><div class="muted">Sepet Ara Toplam</div><div id="k_sub">0</div></div>
          <div class="kpi"><div class="muted">Komisyon</div><div id="k_comm">0</div></div>
          <div class="kpi"><div class="muted">Kargo</div><div id="k_ship">0</div></div>
        </div>
        <div class="span-6">
          <div class="kpi"><div class="muted">Toplam Maliyet</div><div id="k_cost">0</div></div>
          <div class="kpi"><div class="muted">Net Gelir</div><div id="k_net">0</div></div>
          <div class="kpi"><div class="muted">KÃ¢r</div><div id="k_profit" class="k-green">0</div></div>
        </div>
      </div>
      <p class="note"><strong>EÅŸik durumu:</strong> <span id="thresholdState">EÅŸik altÄ±</span>. EÅŸik aÅŸÄ±lÄ±rsa kargo satÄ±cÄ±ya yazÄ±lÄ±r ve kÃ¢r buna gÃ¶re gÃ¼ncellenir.</p>
    </section>
  </div>

  <!-- FIYAT ONERISI ASISTANI -->
  <section class="card span-12" style="margin-top:16px">
    <h2>Fiyat Ã–nerisi AsistanÄ±</h2>
    <div class="row">
      <div><label>Maliyet (TL)</label><input type="number" id="fa_cost" step="0.01" value="200"></div>
      <div><label>Desi (tek Ã¼rÃ¼n)</label><input type="number" id="fa_desi" step="0.01" value="2.5"></div>
      <div><label>Adet (sepette)</label><input type="number" id="fa_qty" step="1" value="1"></div>
      <div><label>Hedef KÃ¢r MarjÄ± (%)</label><input type="number" id="fa_margin" step="0.1" value="20"></div>
      <div><label>Rakip Fiyat (opsiyonel)</label><input type="number" id="fa_comp" step="0.01" placeholder="Ã¶r. 349"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>EÅŸik AltÄ± Senaryosu (kargoyu mÃ¼ÅŸteri Ã¶der)</label>
        <button class="btn" id="fa_under">Hesapla</button>
        <div class="note small" id="fa_under_note"></div>
      </div>
      <div>
        <label>EÅŸik ÃœstÃ¼ Senaryosu (kargoyu satÄ±cÄ± Ã¶der)</label>
        <button class="btn" id="fa_over">Hesapla</button>
        <div class="note small" id="fa_over_note"></div>
      </div>
    </div>
    <div class="grid" style="margin-top:10px">
      <div class="span-6">
        <div class="kpi"><div class="muted">Ã–nerilen Liste FiyatÄ±</div><div id="fa_price">-</div></div>
        <div class="kpi"><div class="muted">Birim KÃ¢r</div><div id="fa_profit">-</div></div>
      </div>
      <div class="span-6">
        <div class="kpi"><div class="muted">Sepet ToplamÄ±</div><div id="fa_subtotal">-</div></div>
        <div class="kpi"><div class="muted">Toplam KÃ¢r</div><div id="fa_totalprofit">-</div></div>
      </div>
    </div>
    <p class="note">Not: EÅŸik altÄ± hesapta fiyat Ã— adet &lt; eÅŸiÄŸe sÄ±ÄŸmazsa uyarÄ± verir. EÅŸik Ã¼stÃ¼ hesapta kargo, toplam desiye gÃ¶re birim baÅŸÄ±na bÃ¶lÃ¼ÅŸtÃ¼rÃ¼lÃ¼r.</p>
  </section>

  <!-- AKILLI FÄ°YAT BULUCU (PÄ°YASA) -->
  <section class="card span-12" style="margin-top:16px">
    <h2>Ä°brahim Bey iÃ§in AkÄ±llÄ± Fiyat Bulucu (Piyasa Modu)</h2>
    <p class="note">Merhabalar Ä°brahim BeyğŸ‘‹ ÃœrÃ¼nÃ¼n maliyeti, desisi ve pazardaki rakip fiyatlarÄ±nÄ± gir; hem rekabetÃ§i olup hem de kÃ¢r bÄ±rakacak liste fiyatÄ±nÄ± Ã¶neririm.</p>

    <div class="row">
      <div><label>ÃœrÃ¼n AdÄ± (ops.)</label><input id="pm_name" placeholder="Ã–rn: 25kg HarÃ§"></div>
      <div><label>GeliÅŸ Maliyeti (TL)</label><input type="number" id="pm_cost" step="0.01" value="200"></div>
      <div><label>Desi</label><input type="number" id="pm_desi" step="0.01" value="2.5"></div>
      <div><label>Hedef KÃ¢r MarjÄ± (%)</label><input type="number" id="pm_margin" step="0.1" value="20"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Rakip En DÃ¼ÅŸÃ¼k Fiyat (TL)</label><input type="number" id="pm_comp_min" step="0.01" placeholder="Ã¶rn. 349"></div>
      <div><label>Rakip Ortalama Fiyat (TL) (ops.)</label><input type="number" id="pm_comp_avg" step="0.01" placeholder="Ã¶rn. 369"></div>
      <div>
        <label>Strateji</label>
        <select id="pm_strategy">
          <option value="below_min">En dÃ¼ÅŸÃ¼kten bir tÄ±k aÅŸaÄŸÄ± (~%1)</option>
          <option value="match_min">En dÃ¼ÅŸÃ¼kle eÅŸit</option>
          <option value="near_avg">Ortalamaya yakÄ±n (~%-3)</option>
          <option value="profit_first">KÃ¢ra Ã¶ncelik ver</option>
        </select>
      </div>
      <div>
        <label>Sepeti 300 TL altÄ±nda tut</label>
        <div class="row">
          <div style="flex:0 0 auto;align-self:center"><input type="checkbox" id="pm_keep_under" checked></div>
          <div><label>Adet</label><input type="number" id="pm_qty" value="1" step="1"></div>
        </div>
      </div>
    </div>

    <div style="margin-top:8px">
      <button class="btn" id="pm_calc">Ã–neriyi Hesapla</button>
    </div>

    <div class="grid" style="margin-top:12px">
      <div class="span-6">
        <div class="kpi"><div class="muted">Ã–nerilen Liste FiyatÄ±</div><div id="pm_price">-</div></div>
        <div class="kpi"><div class="muted">Birim KÃ¢r</div><div id="pm_unit_profit">-</div></div>
      </div>
      <div class="span-6">
        <div class="kpi"><div class="muted">Sepet ToplamÄ±</div><div id="pm_subtotal">-</div></div>
        <div class="kpi"><div class="muted">Toplam KÃ¢r</div><div id="pm_total_profit">-</div></div>
      </div>
    </div>

    <p class="note" id="pm_note"></p>

    <hr style="border-color:#1f2937; margin:14px 0">
    <p class="small muted"><b>Mini KoÃ§:</b> Hafif (dÃ¼ÅŸÃ¼k desi) Ã¼rÃ¼nler eÅŸik Ã¼stÃ¼nde de kÃ¢rlÄ± kalÄ±r. AÄŸÄ±r (yÃ¼ksek desi)
      Ã¼rÃ¼nlerde eÅŸik altÄ± daha avantajlÄ± olabilir. Rakip Ã§ok dÃ¼ÅŸÃ¼kse, kÃ¢r hedefinden aÅŸaÄŸÄ± inmiyoruz â€” kÃ¢r kutsaldÄ±r ğŸ˜Š</p>
  </section>

  <script>
    // ---------- Helpers ----------
    const fmt = n => (isFinite(n) ? new Intl.NumberFormat('tr-TR',{maximumFractionDigits:0}).format(n) : '0');
    const val = el => parseFloat(el.value || '0');

    // Ship price lookup by total desi
    function getShipByDesi(totalDesi){
      const rows = [...document.querySelectorAll('#desiTable tbody tr')];
      for(const r of rows){
        const low = parseFloat(r.querySelector('.d-low').value||'0');
        const high = parseFloat(r.querySelector('.d-high').value||'0');
        const price = parseFloat(r.querySelector('.d-price').value||'0');
        if(totalDesi >= low && totalDesi < high){ return price; }
      }
      return 0; // not found or 0 desi
    }

    function commissionRate(){ return val(document.getElementById('commission'))/100; }
    function threshold(){ return val(document.getElementById('freeThreshold')); }

    // ---------- DESI TABLE ----------
    function addDesiRow(a=0,b=1,p=78){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="d-low" type="number" step="0.01" value="${a}"></td>
        <td><input class="d-high" type="number" step="0.01" value="${b}"></td>
        <td><input class="d-price" type="number" step="0.01" value="${p}"></td>
        <td><button class="btn" onclick="this.closest('tr').remove();recalcAll()">Sil</button></td>`;
      document.querySelector('#desiTable tbody').appendChild(tr);
    }

    function resetDesi(){
      document.querySelector('#desiTable tbody').innerHTML='';
      addDesiRow(0,1,78);
      addDesiRow(1,2,95);
      addDesiRow(2,3,110);
      addDesiRow(3,5,135);
      addDesiRow(5,10,170);
      recalcAll();
    }

    // ---------- PRODUCTS ----------
    function addProductRow(p={name:'',cost:'',desi:'',margin:20}){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="p-name" placeholder="Ã–rn: HarÃ§ 25kg" value="${p.name}"></td>
        <td><input class="p-cost" type="number" step="0.01" value="${p.cost}"></td>
        <td><input class="p-desi" type="number" step="0.01" value="${p.desi}"></td>
        <td><input class="p-margin" type="number" step="0.1" value="${p.margin}"></td>
        <td class="p-under">-</td>
        <td class="p-over">-</td>
        <td><button class="btn" onclick="this.closest('tr').remove();recalcAll()">Sil</button></td>`;
      document.querySelector('#productTable tbody').appendChild(tr);
      tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',recalcAll));
      recalcAll();
    }

    function productShipForOne(desi){ return getShipByDesi(parseFloat(desi||0)); }

    function computeProductSuggestions(){
      const rows=[...document.querySelectorAll('#productTable tbody tr')];
      const cRate=commissionRate();
      rows.forEach(r=>{
        const cost = parseFloat(r.querySelector('.p-cost').value||'0');
        const desi = parseFloat(r.querySelector('.p-desi').value||'0');
        const margin = (parseFloat(r.querySelector('.p-margin').value||'0')/100);
        const denom = 1-(cRate+margin);
        const under = denom>0 ? Math.ceil(cost/denom) : 0;
        const shipOne = productShipForOne(desi);
        const over = denom>0 ? Math.ceil((cost+shipOne)/denom) : 0;
        r.querySelector('.p-under').textContent = fmt(under);
        r.querySelector('.p-over').textContent  = fmt(over);
      });
    }

    // ---------- BASKET ----------
    function addBasketRow(item={name:'',price:'',cost:'',desi:'',qty:1}){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="b-name" value="${item.name}" placeholder="ÃœrÃ¼n adÄ±"></td>
        <td><input class="b-price" type="number" step="0.01" value="${item.price}"></td>
        <td><input class="b-cost" type="number" step="0.01" value="${item.cost}"></td>
        <td><input class="b-desi" type="number" step="0.01" value="${item.desi}"></td>
        <td><input class="b-qty" type="number" step="1" value="${item.qty}"></td>
        <td class="b-line">0</td>
        <td class="b-costline">0</td>
        <td class="b-desiline">0</td>
        <td><button class="btn" onclick="this.closest('tr').remove();recalcAll()">Sil</button></td>`;
      document.querySelector('#basketTable tbody').appendChild(tr);
      tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',recalcAll));
      recalcAll();
    }

    function computeBasket(){
      const rows=[...document.querySelectorAll('#basketTable tbody tr')];
      let subtotal=0, totalCost=0, totalDesi=0;
      rows.forEach(r=>{
        const price=parseFloat(r.querySelector('.b-price').value||'0');
        const cost=parseFloat(r.querySelector('.b-cost').value||'0');
        const desi=parseFloat(r.querySelector('.b-desi').value||'0');
        const qty =parseInt(r.querySelector('.b-qty').value||'0');
        const line=price*qty; const cline=cost*qty; const dline=desi*qty;
        subtotal+=line; totalCost+=cline; totalDesi+=dline;
        r.querySelector('.b-line').textContent=fmt(line);
        r.querySelector('.b-costline').textContent=fmt(cline);
        r.querySelector('.b-desiline').textContent=fmt(dline);
      });
      const cRate=commissionRate();
      const needShip = subtotal >= threshold();
      const ship = needShip ? getShipByDesi(totalDesi) : 0;
      const comm = subtotal * cRate;
      const net = subtotal - ship - comm;
      const profit = net - totalCost;
      document.getElementById('k_sub').textContent = fmt(subtotal);
      document.getElementById('k_cost').textContent= fmt(totalCost);
      document.getElementById('k_ship').textContent= fmt(ship);
      document.getElementById('k_comm').textContent= fmt(comm);
      document.getElementById('k_net').textContent = fmt(net);
      const pf = document.getElementById('k_profit');
      pf.textContent = fmt(profit);
      pf.classList.toggle('k-red', profit<0);
      pf.classList.toggle('k-green', profit>=0);
      document.getElementById('thresholdState').textContent = needShip ? 'EÅÄ°K AÅILDI (Kargoyu satÄ±cÄ± Ã¶der)' : 'EÅÄ°K ALTI (Kargoyu alÄ±cÄ± Ã¶der)';
    }

    function recalcAll(){ computeProductSuggestions(); computeBasket(); }

    // ---------- Events & Init ----------
    document.getElementById('addDesi').addEventListener('click',()=>{addDesiRow(0,0,0)});
    document.getElementById('resetDesi').addEventListener('click',resetDesi);
    document.getElementById('addProduct').addEventListener('click',()=>addProductRow({}));
    document.getElementById('addBasket').addEventListener('click',()=>addBasketRow({}));
    document.getElementById('commission').addEventListener('input',recalcAll);
    document.getElementById('freeThreshold').addEventListener('input',recalcAll);

    resetDesi();
    addProductRow({name:'HarÃ§ 25kg',cost:200,desi:2.5,margin:20});
    addBasketRow({name:'HarÃ§ 25kg',price:350,cost:200,desi:2.5,qty:1});

    // ----- Advisor logic -----
    function adviseUnder(){
      const c = parseFloat(document.getElementById('fa_cost').value||'0');
      const d = parseFloat(document.getElementById('fa_desi').value||'0');
      const q = parseInt(document.getElementById('fa_qty').value||'1');
      const m = parseFloat(document.getElementById('fa_margin').value||'0')/100;
      const comp = parseFloat(document.getElementById('fa_comp').value||'0');
      const r = commissionRate();
      const denom = 1-(r+m);
      const minPrice = denom>0 ? Math.ceil(c/denom) : 0;
      const maxPriceToStayUnder = Math.floor((threshold()-0.01)/Math.max(q,1));
      let note = '';
      if(minPrice>maxPriceToStayUnder){
        note = 'SeÃ§ilen marjla eÅŸik altÄ±nda kalmak imkansÄ±z. En az ' + fmt(minPrice) + ' TL gerekir; ' + q + ' adetle eÅŸik altÄ± sÄ±nÄ±rÄ± ' + fmt(maxPriceToStayUnder) + ' TL.';
        renderAdvisor('-', '-', '-', '-', note);
        return;
      }
      let suggested = minPrice;
      if(comp && suggested>comp){ suggested = comp; note = 'Rakip fiyata uyum iÃ§in ' + fmt(comp) + ' seÃ§ildi.'; }
      const subtotal = suggested*q;
      const comm = subtotal*r;
      const net = subtotal - comm;
      const profitUnit = suggested - c - (suggested*r);
      const totalProfit = net - c*q;
      renderAdvisor(suggested, profitUnit, subtotal, totalProfit, note || 'EÅŸik altÄ±: kargoyu mÃ¼ÅŸteri Ã¶der.');
    }

    function adviseOver(){
      const c = parseFloat(document.getElementById('fa_cost').value||'0');
      const d = parseFloat(document.getElementById('fa_desi').value||'0');
      const q = parseInt(document.getElementById('fa_qty').value||'1');
      const m = parseFloat(document.getElementById('fa_margin').value||'0')/100;
      const comp = parseFloat(document.getElementById('fa_comp').value||'0');
      const r = commissionRate();
      const ship = getShipByDesi(d*q);
      const denom = 1-(r+m);
      let p = denom>0 ? Math.ceil((c + ship/Math.max(q,1))/denom) : 0;
      let note = 'Kargo ' + fmt(ship) + ' TL (toplam desi ' + (d*q) + '). Birim pay ~ ' + fmt(Math.ceil(ship/Math.max(q,1))) + ' TL.';
      if(comp && p>comp){ note += ' UyarÄ±: Ã–neri rakip fiyatÄ±nÄ± (' + fmt(comp) + ') aÅŸÄ±yor.'; }
      const subtotal = p*q; const comm = subtotal*r; const net = subtotal - comm - ship; const profitUnit = (net - c*q)/q; const totalProfit = net - c*q;
      renderAdvisor(p, profitUnit, subtotal, totalProfit, note);
    }

    function renderAdvisor(price,unitProfit,subtotal,totalProfit,note){
      document.getElementById('fa_price').textContent = isFinite(price)? fmt(price):'-';
      document.getElementById('fa_profit').textContent = isFinite(unitProfit)? fmt(unitProfit):'-';
      document.getElementById('fa_subtotal').textContent = isFinite(subtotal)? fmt(subtotal):'-';
      const tp = document.getElementById('fa_totalprofit');
      tp.textContent = isFinite(totalProfit)? fmt(totalProfit):'-';
      tp.classList.toggle('k-red', totalProfit<0);
      tp.classList.toggle('k-green', totalProfit>=0);
      document.getElementById('fa_under_note').textContent = '';
      document.getElementById('fa_over_note').textContent = '';
      if(note){
        if(note.startsWith('Kargo') || note.startsWith('UyarÄ±')) document.getElementById('fa_over_note').textContent = note; else document.getElementById('fa_under_note').textContent = note;
      }
    }

    document.getElementById('fa_under').addEventListener('click', adviseUnder);
    document.getElementById('fa_over').addEventListener('click', adviseOver);

    // --------- Piyasa Modu HesabÄ± ---------
    function clampToStrategy(basePrice, minComp, avgComp, strategy){
      if(!isFinite(basePrice) || basePrice<=0) return 0;
      if(strategy==='profit_first') return basePrice; // kÃ¢ra Ã¶ncelik: piyasa hedefini dikkate alma
      if(!minComp && !avgComp) return basePrice;     // rakip verisi yoksa sadece basePrice

      let target = basePrice;
      if(strategy==='below_min' && minComp){
        target = Math.min(basePrice, Math.max(1, Math.floor(minComp*0.99))); // en dÃ¼ÅŸÃ¼kten ~%1 aÅŸaÄŸÄ±
      }else if(strategy==='match_min' && minComp){
        target = Math.min(basePrice, Math.floor(minComp)); // en dÃ¼ÅŸÃ¼kle eÅŸit
      }else if(strategy==='near_avg' && avgComp){
        target = Math.min(basePrice, Math.floor(avgComp*0.97)); // ortalamaya ~%3 aÅŸaÄŸÄ±sÄ±
      }
      return target;
    }

    function pmCalc(){
      const name    = document.getElementById('pm_name').value.trim();
      const cost    = parseFloat(document.getElementById('pm_cost').value||'0');
      const desi    = parseFloat(document.getElementById('pm_desi').value||'0');
      const marginR = (parseFloat(document.getElementById('pm_margin').value||'0')/100);
      const minComp = parseFloat(document.getElementById('pm_comp_min').value||'0');
      const avgComp = parseFloat(document.getElementById('pm_comp_avg').value||'0');
      const strat   = document.getElementById('pm_strategy').value;
      const keepUnder = document.getElementById('pm_keep_under').checked;
      const qty     = parseInt(document.getElementById('pm_qty').value||'1');

      const r = commissionRate();
      const denom = 1-(r+marginR);
      if(denom<=0){
        document.getElementById('pm_note').textContent = 'Marj + komisyon toplamÄ± %100 veya Ã¼stÃ¼nde olamaz.';
        return;
      }

      // 1) KÃ¢r tabanÄ± (tek Ã¼rÃ¼n)
      const shipOneIfOver = getShipByDesi(desi);
      let basePriceOver   = Math.ceil((cost + shipOneIfOver)/denom); // eÅŸik Ã¼stÃ¼nde (kargo satÄ±cÄ±da)
      let basePriceUnder  = Math.ceil(cost/denom);                   // eÅŸik altÄ±nda (kargo mÃ¼ÅŸteride)

      // 2) EÅŸik tavanÄ± (keepUnder=true ise price * qty < threshold)
      const th = threshold();
      const maxPriceToStayUnder = Math.floor((th-0.01)/Math.max(1,qty));
      const priceCeil = keepUnder ? maxPriceToStayUnder : 10**9;

      // 3) Piyasa stratejisi (kÃ¢rdan aÅŸaÄŸÄ± inmeden)
      let minProfitPrice = keepUnder ? basePriceUnder : basePriceOver;
      let strategyPrice  = clampToStrategy(minProfitPrice, isFinite(minComp)?minComp:0, isFinite(avgComp)?avgComp:0, strat);

      // 4) Son Ã¶neri
      let suggested = Math.min(priceCeil, Math.max(minProfitPrice, strategyPrice));
      if(!isFinite(suggested) || suggested<=0) suggested = minProfitPrice;

      // 5) Sepet, komisyon, kargo ve kÃ¢r
      const subtotal = suggested * qty;
      const needShip = !keepUnder && (subtotal >= th); // keepUnder aÃ§Ä±ksa zaten altÄ±ndayÄ±z
      const ship = needShip ? getShipByDesi(desi*qty) : 0;
      const comm = subtotal * r;
      const net  = subtotal - comm - ship;
      const totalProfit = net - cost*qty;
      const unitProfit  = totalProfit / Math.max(1,qty);

      // 6) Not/koÃ§
      let note = [];
      if(keepUnder){ note.push(`EÅŸik altÄ± hedefi aÃ§Ä±k: ${qty} adet Ã— ${fmt(suggested)} = ${fmt(subtotal)} TL (< ${fmt(th)})`); }
      if(strat==='below_min' && minComp){ note.push(`Rakip en dÃ¼ÅŸÃ¼k ${fmt(minComp)} TL. KÃ¢rdan taviz vermeden bir tÄ±k altÄ±nda konumlandÄ±.`); }
      if(strat==='match_min' && minComp){ note.push(`Rakip en dÃ¼ÅŸÃ¼k ${fmt(minComp)} TL ile eÅŸleÅŸtirildi (kÃ¢r korundu).`); }
      if(strat==='near_avg' && avgComp){ note.push(`Rakip ortalama ${fmt(avgComp)} TL civarÄ±; daha rekabetÃ§i olmasÄ± iÃ§in biraz altÄ±nda.`); }
      if(strat==='profit_first'){ note.push(`KÃ¢ra Ã¶ncelik verildi; piyasa fiyatÄ± sadece referans.`); }
      if(suggested===minProfitPrice && (minComp||avgComp)){ note.push(`Not: Rakip hedefi Ã§ok dÃ¼ÅŸÃ¼k kaldÄ±ÄŸÄ± iÃ§in kÃ¢r tabanÄ±nÄ±n altÄ±na inmedi.`); }
      if(needShip){ note.push(`EÅŸik aÅŸÄ±ldÄ±: kargo ${fmt(ship)} TL (toplam desi ${desi*qty}).`); }

      // 7) Ekrana yaz
      document.getElementById('pm_price').textContent = fmt(suggested);
      document.getElementById('pm_unit_profit').textContent = fmt(unitProfit);
      document.getElementById('pm_subtotal').textContent = fmt(subtotal);
      const tp = document.getElementById('pm_total_profit');
      tp.textContent = fmt(totalProfit);
      tp.classList.toggle('k-red', totalProfit<0);
      tp.classList.toggle('k-green', totalProfit>=0);
      document.getElementById('pm_note').textContent = note.join(' ');
    }

    document.getElementById('pm_calc').addEventListener('click', pmCalc);
  </script>
</body>
</html>
