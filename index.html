<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trendyol FiyatlandÄ±rma SimÃ¼latÃ¶rÃ¼</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --accent:#22c55e; --border:#1f2937; }
    *{box-sizing:border-box}
    body{font-family:Arial, Helvetica, sans-serif;background:linear-gradient(180deg,#0b1023,#0f172a);color:#e5e7eb;margin:0;padding:24px}
    h1{font-size:26px;margin:0 0 8px}
    p.sub{color:var(--muted);margin:0 0 22px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 4px 12px rgba(0,0,0,.25)}
    .span-12{grid-column:span 12}
    .span-6{grid-column:span 12}
    @media(min-width:980px){.span-6{grid-column:span 6}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;background:#0b1220;border:1px solid #1f2937;color:#e5e7eb;border-radius:8px;padding:8px 10px;outline:none}
    input:focus{border-color:#334155}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}
    th{color:#cbd5e1;font-weight:600;background:#0b1220;position:sticky;top:0}
    .btn{display:inline-flex;align-items:center;gap:6px;background:#1e293b;border:1px solid #334155;color:#e5e7eb;padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn:hover{background:#243041}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row>*{flex:1 1 140px}
    .kpi{display:grid;grid-template-columns:1fr auto;gap:8px;padding:10px;border:1px dashed #334155;border-radius:12px}
    .k-green{color:#22c55e}
    .k-red{color:#f87171}
    .small{font-size:12px}
    .note{color:#94a3b8;font-size:12px;margin-top:8px}
    .pill{background:#0b1220;border:1px solid #2a3346;border-radius:999px;padding:4px 10px;font-size:12px;color:#cbd5e1}
  </style>
</head>
<body>
  <h1>Trendyol FiyatlandÄ±rma SimÃ¼latÃ¶rÃ¼</h1>
  <p class="sub">Komisyon, kargo, platform Ã¼creti ve kÃ¢r hesabÄ±. <span class="pill">v2.0</span></p>

  <div class="grid">
    <section class="card span-12">
      <h2>Ä°brahim Beyâ€™e Mini Not ğŸ’›</h2>
      <p class="small muted">0â€“150 TL: satÄ±cÄ±dan <b>43 TL</b>, 150â€“300 TL: satÄ±cÄ±dan <b>75 TL</b> kargo; her sipariÅŸte <b>10 TL</b> platform Ã¼creti; komisyon varsayÄ±lan %20 (deÄŸiÅŸtirilebilir). 300 TL Ã¼stÃ¼nde kargo, toplam desiye gÃ¶re tablodan alÄ±nÄ±r.</p>
    </section>

    <section class="card span-6">
      <h2>Ayarlar</h2>
      <div class="row">
        <div>
          <label>Komisyon OranÄ± (%)</label>
          <input type="number" id="commission" value="20" step="0.1" />
        </div>
        <div>
          <label>Platform Ãœcreti (TL / sipariÅŸ)</label>
          <input type="number" id="platformFee" value="10" step="0.01" />
        </div>
        <div>
          <label>EÅŸik-1 (TL)</label>
          <input type="number" id="t1" value="150" />
        </div>
        <div>
          <label>EÅŸik-2 (TL)</label>
          <input type="number" id="t2" value="300" />
        </div>
        <div>
          <label>Kargo (0â€“EÅŸik1) TL</label>
          <input type="number" id="shipLow" value="43" step="0.01" />
        </div>
        <div>
          <label>Kargo (EÅŸik1â€“EÅŸik2) TL</label>
          <input type="number" id="shipMid" value="75" step="0.01" />
        </div>
      </div>
      <div style="height:10px"></div>
      <label>300+ TL Kargo Desi Tablosu (altâ€“Ã¼stâ€“fiyat)</label>
      <table id="desiTable">
        <thead><tr><th>Desi Alt</th><th>Desi Ãœst</th><th>Kargo (TL)</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px"><button class="btn" id="addDesi">+ SatÄ±r Ekle</button> <button class="btn" id="resetDesi">SÄ±fÄ±rla</button></div>
      <p class="note">300 TL Ã¼zerindeki sepetlerde kargo, toplam desiye gÃ¶re bu tablodan hesaplanÄ±r.</p>
    </section>

    <section class="card span-6">
      <h2>ÃœrÃ¼nler</h2>
      <table id="productTable">
        <thead>
          <tr>
            <th>ÃœrÃ¼n</th>
            <th>Maliyet (TL)</th>
            <th>Desi</th>
            <th>Hedef Marj (%)</th>
            <th>Ã–neri (EÅŸik AltÄ±)</th>
            <th>Ã–neri (EÅŸik ÃœstÃ¼)</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px"><button class="btn" id="addProduct">+ ÃœrÃ¼n SatÄ±rÄ±</button></div>
      <p class="note">EÅŸik altÄ± Ã¶neri, 0â€“150 ve 150â€“300 bantlarÄ±nÄ± kÃ¢rÄ± koruyarak dener ve uygun olanÄ± seÃ§er.</p>
    </section>

    <section class="card span-12">
      <h2>Sepet SimÃ¼latÃ¶rÃ¼</h2>
      <table id="basketTable">
        <thead>
          <tr>
            <th>ÃœrÃ¼n</th>
            <th>Birim Fiyat</th>
            <th>Birim Maliyet</th>
            <th>Desi</th>
            <th>Adet</th>
            <th>SatÄ±r TutarÄ±</th>
            <th>Maliyet ToplamÄ±</th>
            <th>Desi ToplamÄ±</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:8px"><button class="btn" id="addBasket">+ SatÄ±r Ekle</button></div>

      <div class="grid" style="margin-top:16px">
        <div class="span-6">
          <div class="kpi"><div class="muted">Sepet Ara Toplam</div><div id="k_sub">0</div></div>
          <div class="kpi"><div class="muted">Komisyon</div><div id="k_comm">0</div></div>
          <div class="kpi"><div class="muted">Kargo</div><div id="k_ship">0</div></div>
          <div class="kpi"><div class="muted">Platform Ãœcreti</div><div id="k_pf">0</div></div>
        </div>
        <div class="span-6">
          <div class="kpi"><div class="muted">Toplam Maliyet</div><div id="k_cost">0</div></div>
          <div class="kpi"><div class="muted">Net Gelir</div><div id="k_net">0</div></div>
          <div class="kpi"><div class="muted">KÃ¢r</div><div id="k_profit" class="k-green">0</div></div>
        </div>
      </div>
      <p class="note"><b>EÅŸik durumu:</b> <span id="thresholdState">EÅŸik altÄ±</span>. 0â€“150: sabit shipLow; 150â€“300: shipMid; 300+: desi tablosu.</p>
    </section>
  </div>

  <section class="card span-12" style="margin-top:16px">
    <h2>Fiyat AsistanÄ±</h2>
    <div class="row">
      <div><label>Maliyet (TL)</label><input type="number" id="fa_cost" step="0.01" value="200"></div>
      <div><label>Desi</label><input type="number" id="fa_desi" step="0.01" value="2.5"></div>
      <div><label>Adet</label><input type="number" id="fa_qty" step="1" value="1"></div>
      <div><label>Hedef Marj (%)</label><input type="number" id="fa_margin" step="0.1" value="20"></div>
      <div><label>Rakip Fiyat (ops.)</label><input type="number" id="fa_comp" step="0.01" placeholder="Ã¶r. 349"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <div>
        <label>EÅŸik AltÄ±</label>
        <button class="btn" id="fa_under">Hesapla</button>
        <div class="note small" id="fa_under_note"></div>
      </div>
      <div>
        <label>EÅŸik ÃœstÃ¼ (300+)</label>
        <button class="btn" id="fa_over">Hesapla</button>
        <div class="note small" id="fa_over_note"></div>
      </div>
    </div>
    <div class="grid" style="margin-top:10px">
      <div class="span-6">
        <div class="kpi"><div class="muted">Ã–nerilen Fiyat</div><div id="fa_price">-</div></div>
        <div class="kpi"><div class="muted">Birim KÃ¢r</div><div id="fa_profit">-</div></div>
      </div>
      <div class="span-6">
        <div class="kpi"><div class="muted">Sepet ToplamÄ±</div><div id="fa_subtotal">-</div></div>
        <div class="kpi"><div class="muted">Toplam KÃ¢r</div><div id="fa_totalprofit">-</div></div>
      </div>
    </div>
  </section>

  <section class="card span-12" style="margin-top:16px">
    <h2>Piyasa Modu</h2>
    <p class="note">KÃ¢r tabanÄ±nÄ±n altÄ±na <b>asla</b> inmez. EÅŸik altÄ± istenirse Ã¶nce 0â€“150, sonra 150â€“300 bandÄ± denenir.</p>

    <div class="row">
      <div><label>ÃœrÃ¼n AdÄ± (ops.)</label><input id="pm_name" placeholder="Ã–rn: 25kg HarÃ§"></div>
      <div><label>GeliÅŸ Maliyeti (TL)</label><input type="number" id="pm_cost" step="0.01" value="200"></div>
      <div><label>Desi</label><input type="number" id="pm_desi" step="0.01" value="2.5"></div>
      <div><label>Hedef Marj (%)</label><input type="number" id="pm_margin" step="0.1" value="20"></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div><label>Rakip En DÃ¼ÅŸÃ¼k (TL)</label><input type="number" id="pm_comp_min" step="0.01" placeholder="Ã¶rn. 349"></div>
      <div><label>Rakip Ortalama (TL) (ops.)</label><input type="number" id="pm_comp_avg" step="0.01" placeholder="Ã¶rn. 369"></div>
      <div>
        <label>Strateji</label>
        <select id="pm_strategy">
          <option value="below_min">En dÃ¼ÅŸÃ¼kten biraz aÅŸaÄŸÄ± (~%1)</option>
          <option value="match_min">En dÃ¼ÅŸÃ¼kle eÅŸit</option>
          <option value="near_avg">Ortalamaya yakÄ±n (~%-3)</option>
          <option value="profit_first">KÃ¢ra Ã¶ncelik</option>
        </select>
      </div>
      <div>
        <label>Sepeti 300 TL altÄ±nda tut</label>
        <div class="row">
          <div style="flex:0 0 auto;align-self:center"><input type="checkbox" id="pm_keep_under" checked></div>
          <div><label>Adet</label><input type="number" id="pm_qty" value="1" step="1"></div>
        </div>
      </div>
    </div>

    <div style="margin-top:8px"><button class="btn" id="pm_calc">Ã–neriyi Hesapla</button></div>

    <div class="grid" style="margin-top:12px">
      <div class="span-6">
        <div class="kpi"><div class="muted">Ã–nerilen Fiyat</div><div id="pm_price">-</div></div>
        <div class="kpi"><div class="muted">Birim KÃ¢r</div><div id="pm_unit_profit">-</div></div>
      </div>
      <div class="span-6">
        <div class="kpi"><div class="muted">Sepet ToplamÄ±</div><div id="pm_subtotal">-</div></div>
        <div class="kpi"><div class="muted">Toplam KÃ¢r</div><div id="pm_total_profit">-</div></div>
      </div>
    </div>

    <p class="note" id="pm_note"></p>
  </section>

  <script>
    const fmt = n => (isFinite(n) ? new Intl.NumberFormat('tr-TR',{maximumFractionDigits:0}).format(n) : '0');
    const val = el => parseFloat(el.value || '0');

    const commissionRate = () => val(document.getElementById('commission'))/100;
    const platformFee = () => val(document.getElementById('platformFee'));
    const T1 = () => val(document.getElementById('t1'));
    const T2 = () => val(document.getElementById('t2'));
    const shipLow = () => val(document.getElementById('shipLow'));
    const shipMid = () => val(document.getElementById('shipMid'));

    function getShipByDesi(totalDesi){
      const rows = [...document.querySelectorAll('#desiTable tbody tr')];
      for(const r of rows){
        const low = parseFloat(r.querySelector('.d-low')?.value||'0');
        const high = parseFloat(r.querySelector('.d-high')?.value||'0');
        const price = parseFloat(r.querySelector('.d-price')?.value||'0');
        if(totalDesi >= low && totalDesi < high) return price;
      }
      return 0;
    }

    function addDesiRow(a=0,b=1,p=78){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="d-low" type="number" step="0.01" value="${a}"></td>
        <td><input class="d-high" type="number" step="0.01" value="${b}"></td>
        <td><input class="d-price" type="number" step="0.01" value="${p}"></td>
        <td><button class="btn" onclick="this.closest('tr').remove();recalcAll()">Sil</button></td>`;
      document.querySelector('#desiTable tbody').appendChild(tr);
    }

    function resetDesi(){
      document.querySelector('#desiTable tbody').innerHTML='';
      addDesiRow(0,1,78);
      addDesiRow(1,2,95);
      addDesiRow(2,3,110);
      addDesiRow(3,5,135);
      addDesiRow(5,10,170);
      recalcAll();
    }

    function addProductRow(p={name:'',cost:'',desi:'',margin:20}){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="p-name" placeholder="Ã–rn: HarÃ§ 25kg" value="${p.name}"></td>
        <td><input class="p-cost" type="number" step="0.01" value="${p.cost}"></td>
        <td><input class="p-desi" type="number" step="0.01" value="${p.desi}"></td>
        <td><input class="p-margin" type="number" step="0.1" value="${p.margin}"></td>
        <td class="p-under">-</td>
        <td class="p-over">-</td>
        <td><button class="btn" onclick="this.closest('tr').remove();recalcAll()">Sil</button></td>`;
      document.querySelector('#productTable tbody').appendChild(tr);
      tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',recalcAll));
      recalcAll();
    }

    const requiredPrice = (unitCost, marginRate, commRate, extraPerUnit) => {
      const denom = 1 - (marginRate + commRate);
      return denom>0 ? Math.ceil((unitCost + extraPerUnit)/denom) : Infinity;
    };

    function computeProductSuggestions(){
      const rows=[...document.querySelectorAll('#productTable tbody tr')];
      const r = commissionRate();
      const pf = platformFee();
      const t1=T1(), t2=T2();
      rows.forEach(row=>{
        const cost = parseFloat(row.querySelector('.p-cost')?.value||'0');
        const desi = parseFloat(row.querySelector('.p-desi')?.value||'0');
        const m    = (parseFloat(row.querySelector('.p-margin')?.value||'0')/100);
        // Alt bant 1: 0â€“t1
        const pLow  = requiredPrice(cost, m, r, pf + shipLow());
        const validLow = pLow < t1;
        // Alt bant 2: t1â€“t2
        const pMid  = requiredPrice(cost, m, r, pf + shipMid());
        const validMid = pMid < t2 && pMid >= t1;
        // EÅŸik altÄ± Ã¶neri: uygun olanÄ±n en dÃ¼ÅŸÃ¼ÄŸÃ¼
        let under = Infinity;
        if(validLow) under = Math.min(under, pLow);
        if(validMid) under = Math.min(under, pMid);
        // EÅŸik Ã¼stÃ¼: 300+ â†’ desi tablosu
        const shipOne = getShipByDesi(desi);
        const over = requiredPrice(cost, m, r, pf + shipOne);
        row.querySelector('.p-under').textContent = isFinite(under)? fmt(under) : 'â€”';
        row.querySelector('.p-over').textContent  = isFinite(over)? fmt(over) : 'â€”';
      });
    }

    function addBasketRow(item={name:'',price:'',cost:'',desi:'',qty:1}){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="b-name" value="${item.name}" placeholder="ÃœrÃ¼n adÄ±"></td>
        <td><input class="b-price" type="number" step="0.01" value="${item.price}"></td>
        <td><input class="b-cost" type="number" step="0.01" value="${item.cost}"></td>
        <td><input class="b-desi" type="number" step="0.01" value="${item.desi}"></td>
        <td><input class="b-qty" type="number" step="1" value="${item.qty}"></td>
        <td class="b-line">0</td>
        <td class="b-costline">0</td>
        <td class="b-desiline">0</td>
        <td><button class="btn" onclick="this.closest('tr').remove();recalcAll()">Sil</button></td>`;
      document.querySelector('#basketTable tbody').appendChild(tr);
      tr.querySelectorAll('input').forEach(i=>i.addEventListener('input',recalcAll));
      recalcAll();
    }

    function computeBasket(){
      const rows=[...document.querySelectorAll('#basketTable tbody tr')];
      let subtotal=0, totalCost=0, totalDesi=0;
      rows.forEach(rw=>{
        const price=parseFloat(rw.querySelector('.b-price')?.value||'0');
        const cost=parseFloat(rw.querySelector('.b-cost')?.value||'0');
        const desi=parseFloat(rw.querySelector('.b-desi')?.value||'0');
        const qty =parseInt(rw.querySelector('.b-qty')?.value||'0');
        const line=price*qty; const cline=cost*qty; const dline=desi*qty;
        subtotal+=line; totalCost+=cline; totalDesi+=dline;
        rw.querySelector('.b-line').textContent=fmt(line);
        rw.querySelector('.b-costline').textContent=fmt(cline);
        rw.querySelector('.b-desiline').textContent=fmt(dline);
      });
      const r = commissionRate();
      const t1=T1(), t2=T2();
      let ship = 0, bandText = '';
      if(subtotal < t1){ ship = shipLow(); bandText = `0â€“${fmt(t1)}: sabit kargo`; }
      else if(subtotal < t2){ ship = shipMid(); bandText = `${fmt(t1)}â€“${fmt(t2)}: sabit kargo`; }
      else { ship = getShipByDesi(totalDesi); bandText = `300+: desi kargo`; }
      const pf = platformFee();
      const comm = subtotal * r;
      const net = subtotal - ship - pf - comm;
      const profit = net - totalCost;
      document.getElementById('k_sub').textContent = fmt(subtotal);
      document.getElementById('k_cost').textContent= fmt(totalCost);
      document.getElementById('k_ship').textContent= fmt(ship);
      document.getElementById('k_comm').textContent= fmt(comm);
      document.getElementById('k_pf').textContent  = fmt(pf);
      document.getElementById('k_net').textContent = fmt(net);
      const pfEl = document.getElementById('k_profit');
      pfEl.textContent = fmt(profit);
      pfEl.classList.toggle('k-red', profit<0);
      pfEl.classList.toggle('k-green', profit>=0);
      document.getElementById('thresholdState').textContent = bandText;
    }

    function recalcAll(){ computeProductSuggestions(); computeBasket(); }

    document.getElementById('addDesi').addEventListener('click',()=>{addDesiRow(0,0,0)});
    document.getElementById('resetDesi').addEventListener('click',resetDesi);
    document.getElementById('addProduct').addEventListener('click',()=>addProductRow({}));
    document.getElementById('addBasket').addEventListener('click',()=>addBasketRow({}));
    ['commission','platformFee','t1','t2','shipLow','shipMid'].forEach(id=>{
      document.getElementById(id).addEventListener('input',recalcAll);
    });

    resetDesi();
    addProductRow({name:'HarÃ§ 25kg',cost:200,desi:2.5,margin:20});
    addBasketRow({name:'HarÃ§ 25kg',price:350,cost:200,desi:2.5,qty:1});

    function renderAdvisor(price,unitProfit,subtotal,totalProfit,note){
      document.getElementById('fa_price').textContent = isFinite(price)? fmt(price):'-';
      document.getElementById('fa_profit').textContent = isFinite(unitProfit)? fmt(unitProfit):'-';
      document.getElementById('fa_subtotal').textContent = isFinite(subtotal)? fmt(subtotal):'-';
      const tp = document.getElementById('fa_totalprofit');
      tp.textContent = isFinite(totalProfit)? fmt(totalProfit):'-';
      tp.classList.toggle('k-red', totalProfit<0);
      tp.classList.toggle('k-green', totalProfit>=0);
      document.getElementById('fa_under_note').textContent = '';
      document.getElementById('fa_over_note').textContent = '';
      if(note){
        if(note.startsWith('300+')) document.getElementById('fa_over_note').textContent = note; else document.getElementById('fa_under_note').textContent = note;
      }
    }

    function adviseUnder(){
      const c = val(document.getElementById('fa_cost'));
      const d = val(document.getElementById('fa_desi'));
      const q = Math.max(1, parseInt(document.getElementById('fa_qty').value||'1'));
      const m = val(document.getElementById('fa_margin'))/100;
      const comp = val(document.getElementById('fa_comp'));
      const r = commissionRate();
      const pf = platformFee();
      const t1=T1(), t2=T2();

      // Deneme 1: 0â€“t1 bandÄ±
      const pLow = requiredPrice(c, m, r, (pf + shipLow())/q + (q>1?0:0));
      // Deneme 2: t1â€“t2 bandÄ±
      const pMid = requiredPrice(c, m, r, (pf + shipMid())/q + (q>1?0:0));

      let suggested = Infinity; let note = '';
      if(pLow*q < t1){ suggested = pLow; note = `0â€“${fmt(t1)} bandÄ± seÃ§ildi.`; }
      else if(pMid*q < t2){ suggested = pMid; note = `${fmt(t1)}â€“${fmt(t2)} bandÄ± seÃ§ildi.`; }
      else { renderAdvisor('-', '-', '-', '-', 'EÅŸik altÄ± mÃ¼mkÃ¼n deÄŸil; 300+ deÄŸerlendirin.'); return; }

      if(comp && suggested>comp){ suggested = comp; note += ' Rakip fiyata uyduruldu.'; }

      const subtotal = suggested*q;
      const comm = subtotal*r;
      const ship = subtotal < t1 ? shipLow() : shipMid();
      const net  = subtotal - comm - pf - ship;
      const totalProfit = net - c*q;
      const unitProfit = totalProfit/q;
      renderAdvisor(suggested, unitProfit, subtotal, totalProfit, note);
    }

    function adviseOver(){
      const c = val(document.getElementById('fa_cost'));
      const d = val(document.getElementById('fa_desi'));
      const q = Math.max(1, parseInt(document.getElementById('fa_qty').value||'1'));
      const m = val(document.getElementById('fa_margin'))/100;
      const comp = val(document.getElementById('fa_comp'));
      const r = commissionRate();
      const pf = platformFee();
      const t2=T2();

      const shipTotal = getShipByDesi(d*q);
      const p = requiredPrice(c, m, r, (pf + shipTotal)/q);
      let suggested = p;
      let note = `300+ bandÄ±: toplam kargo ${fmt(shipTotal)} TL (desi ${d*q}).`;
      if(comp && suggested>comp){ note += ` UyarÄ±: Ã–neri rakip ${fmt(comp)} TL Ã¼stÃ¼nde.`; }

      const subtotal = suggested*q;
      if(subtotal < t2){ // GÃ¼venlik: yanlÄ±ÅŸlÄ±kla 300 altÄ±na dÃ¼ÅŸmesin
        const adjust = Math.ceil((t2 + 1)/q);
        suggested = Math.max(suggested, adjust);
      }
      const comm = suggested*q*r;
      const net  = suggested*q - comm - pf - shipTotal;
      const totalProfit = net - c*q;
      const unitProfit = totalProfit/q;
      renderAdvisor(suggested, unitProfit, suggested*q, totalProfit, note);
    }

    document.getElementById('fa_under').addEventListener('click', adviseUnder);
    document.getElementById('fa_over').addEventListener('click', adviseOver);

    function clampToStrategy(basePrice, minComp, avgComp, strategy){
      if(!isFinite(basePrice) || basePrice<=0) return 0;
      if(strategy==='profit_first') return basePrice;
      if(!minComp && !avgComp) return basePrice;
      let target = basePrice;
      if(strategy==='below_min' && minComp){ target = Math.min(basePrice, Math.max(1, Math.floor(minComp*0.99))); }
      else if(strategy==='match_min' && minComp){ target = Math.min(basePrice, Math.floor(minComp)); }
      else if(strategy==='near_avg' && avgComp){ target = Math.min(basePrice, Math.floor(avgComp*0.97)); }
      return target;
    }

    function pmCalc(){
      const cost    = val(document.getElementById('pm_cost'));
      const desi    = val(document.getElementById('pm_desi'));
      const marginR = val(document.getElementById('pm_margin'))/100;
      const minComp = val(document.getElementById('pm_comp_min'));
      const avgComp = val(document.getElementById('pm_comp_avg'));
      const strat   = document.getElementById('pm_strategy').value;
      const keepUnder = document.getElementById('pm_keep_under').checked;
      const qty     = Math.max(1, parseInt(document.getElementById('pm_qty').value||'1'));

      const r = commissionRate();
      const pf = platformFee();
      const t1=T1(), t2=T2();

      const denom = 1-(r+marginR);
      if(denom<=0){ document.getElementById('pm_note').textContent = 'Marj + komisyon %100 veya Ã¼zeri olamaz.'; return; }

      let minProfitPrice = Infinity, noteParts=[];

      if(keepUnder){
        // Ã–nce 0â€“t1, sonra t1â€“t2 dener
        const pLow = requiredPrice(cost, marginR, r, (pf + shipLow())/qty);
        if(pLow*qty < t1){ minProfitPrice = pLow; noteParts.push(`0â€“${fmt(t1)} bandÄ± uygun.`); }
        else {
          const pMid = requiredPrice(cost, marginR, r, (pf + shipMid())/qty);
          if(pMid*qty < t2){ minProfitPrice = pMid; noteParts.push(`${fmt(t1)}â€“${fmt(t2)} bandÄ± uygun.`); }
        }
        if(!isFinite(minProfitPrice) || minProfitPrice===Infinity){ document.getElementById('pm_note').textContent = 'EÅŸik altÄ± kÃ¢rlÄ± fiyat bulunamadÄ±. 300+ deneyin.'; return; }
      } else {
        const shipTotal = getShipByDesi(desi*qty);
        minProfitPrice = requiredPrice(cost, marginR, r, (pf + shipTotal)/qty);
        noteParts.push(`300+; kargo toplamÄ± ${fmt(shipTotal)} TL.`);
        if(minProfitPrice*qty < t2){ minProfitPrice = Math.ceil((t2+1)/qty); }
      }

      let strategyPrice  = clampToStrategy(minProfitPrice, isFinite(minComp)?minComp:0, isFinite(avgComp)?avgComp:0, strat);
      let suggested = Math.max(minProfitPrice, strategyPrice);

      const subtotal = suggested*qty;
      let ship=0; if(subtotal < t1) ship=shipLow(); else if(subtotal < t2) ship=shipMid(); else ship=getShipByDesi(desi*qty);
      const comm = subtotal*r; const net = subtotal - comm - pf - ship; const totalProfit = net - cost*qty; const unitProfit = totalProfit/qty;

      if(totalProfit < 0){ // gÃ¼venlik
        suggested = requiredPrice(cost, marginR, r, (pf + ship)/qty);
      }

      document.getElementById('pm_price').textContent = fmt(suggested);
      document.getElementById('pm_unit_profit').textContent = fmt(unitProfit);
      document.getElementById('pm_subtotal').textContent = fmt(subtotal);
      const tp = document.getElementById('pm_total_profit');
      tp.textContent = fmt(totalProfit);
      tp.classList.toggle('k-red', totalProfit<0);
      tp.classList.toggle('k-green', totalProfit>=0);
      document.getElementById('pm_note').textContent = noteParts.join(' ');
    }

    document.getElementById('pm_calc').addEventListener('click', pmCalc);
  </script>
</body>
</html>
